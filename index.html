<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heart Rate Logger</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js and plugins via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* Use the Inter font, which is clean and modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        html {
            font-family: 'Inter', sans-serif;
        }
        
        /* Ensure the app takes the full height and prevents bouncing */
        html, body {
            height: 100%;
            overflow: hidden;
        }

        /* Custom style for the large BPM text for performance */
        #bpmDisplay {
            font-weight: 900; /* Black weight */
            font-size: 6rem; /* Responsive large text */
            line-height: 1;
        }
        
        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            #bpmDisplay {
                font-size: 4rem;
            }
        }

        /* Helper class for button icons */
        .btn-icon {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
        }
    </style>
</head>
<body class="flex flex-col h-full text-gray-100 overflow-hidden">

    <!-- Status Header (R1.2) -->
    <header class="bg-gray-800 shadow-md p-2 flex items-center justify-between flex-shrink-0 px-4">
        <!-- Status Side -->
        <div class="flex items-center">
            <span id="statusIndicator" class="w-3 h-3 rounded-full mr-2 bg-gray-500"></span>
            <span id="statusDisplay" class="text-sm font-semibold text-white">Idle</span>
            <span id="errorDisplay" class="text-xs text-red-400 ml-2 truncate max-w-[150px]"></span>
        </div>
        <!-- Battery Side (New) -->
        <div id="batteryDisplay" class="flex items-center text-gray-400 hidden">
            <span id="batteryLevel" class="text-sm font-bold mr-1">--%</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h14a2 2 0 012 2v2a2 2 0 01-2 2H3a2 2 0 01-2-2v-2a2 2 0 012-2zm16 2h2"></path></svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col p-4 overflow-y-auto space-y-4">
        
        <!-- Live BPM Display (R2.1) -->
        <div class="bg-gray-800 rounded-lg p-4 flex flex-row justify-center items-baseline">
            <span id="bpmDisplay" class="text-red-400">--</span>
            <span class="text-lg font-semibold text-gray-400 ml-2">BPM</span>
        </div>

        <!-- Stats Grid (R2.2, R2.3, R2.4, R2.5) -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <!-- Session Timer -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                <span class="font-semibold text-blue-300 text-sm">Session</span>
                <span id="sessionTimer" class="text-2xl font-bold">00:00:00</span>
            </div>
            <!-- Segment Timer -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                <span class="font-semibold text-blue-300 text-sm">Segment</span>
                <span id="segmentTimer" class="text-2xl font-bold">00:00:00</span>
            </div>
            <!-- Session Avg BPM -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                <span class="font-semibold text-green-300 text-sm">Session Avg</span>
                <span id="sessionAvgBpm" class="text-2xl font-bold">--</span>
            </div>
            <!-- Segment Avg BPM -->
            <div class="bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                <span class="font-semibold text-green-300 text-sm">Segment Avg</span>
                <span id="segmentAvgBpm" class="text-2xl font-bold">--</span>
            </div>
        </div>

        <!-- Live Chart (R4.1) -->
        <div class="flex-grow bg-gray-800 rounded-lg p-4 relative min-h-[200px] sm:min-h-[300px]">
            <canvas id="hrChart"></canvas>
        </div>
    </main>

    <!-- Controls (R3.1, R3.2, R3.3) -->
    <footer class="flex-shrink-0 grid grid-cols-4 gap-2 p-4 bg-gray-900 border-t border-gray-700">
        <!-- Start Button -->
        <button id="startButton" class="p-3 bg-green-600 text-white font-bold rounded-lg shadow-lg active:bg-green-700 disabled:opacity-50 flex justify-center items-center" aria-label="Start">
            <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.118v3.764a1 1 0 001.555.832l3.197-1.882a1 1 0 000-1.664l-3.197-1.882z" clip-rule="evenodd"></path></svg>
        </button>
        <!-- Pause / Export Button -->
        <button id="pauseButton" class="p-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg active:bg-blue-700 disabled:opacity-50 flex justify-center items-center" aria-label="Pause" disabled>
            <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
        </button>
        <!-- Mark Button -->
        <button id="markButton" class="p-3 bg-yellow-500 text-black font-bold rounded-lg shadow-lg active:bg-yellow-600 disabled:opacity-50 flex justify-center items-center" aria-label="Mark Segment" disabled>
            <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v5a1 1 0 11-2 0V6z" clip-rule="evenodd"></path></svg>
        </button>
        <!-- Stop Button -->
        <button id="stopButton" class="p-3 bg-red-600 text-white font-bold rounded-lg shadow-lg active:bg-red-700 disabled:opacity-50 flex justify-center items-center" aria-label="Stop" disabled>
            <svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 6a2 2 0 00-2 2v4a2 2 0 002 2h4a2 2 0 002-2v-4a2 2 0 00-2-2H8z" clip-rule="evenodd"></path></svg>
        </button>
    </footer>

    <script>
        // --- 1. DOM Element References ---
        const statusIndicator = document.getElementById('statusIndicator');
        const statusDisplay = document.getElementById('statusDisplay');
        const errorDisplay = document.getElementById('errorDisplay');
        const batteryDisplay = document.getElementById('batteryDisplay'); // NEW
        const batteryLevelEl = document.getElementById('batteryLevel'); // NEW
        
        const bpmDisplay = document.getElementById('bpmDisplay');
        const sessionTimer = document.getElementById('sessionTimer');
        const segmentTimer = document.getElementById('segmentTimer');
        const sessionAvgBpm = document.getElementById('sessionAvgBpm');
        const segmentAvgBpm = document.getElementById('segmentAvgBpm');
        
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const markButton = document.getElementById('markButton');
        const pauseButton = document.getElementById('pauseButton'); 
        const chartCanvas = document.getElementById('hrChart');

        // --- 2. State Variables ---
        let bluetoothDevice = null;
        let hrCharacteristic = null;
        let batteryCharacteristic = null; // NEW
        let chartInstance = null;
        
        // Reverted: Back to simple array of numbers (No CSV export needed)
        let sessionReadings = []; 
        let segmentReadings = []; 
        
        let sessionStartTime = 0;
        let segmentStartTime = 0;
        
        // Timer state
        let sessionTimerInterval = null;
        let segmentTimerInterval = null;
        let maxSessionTimeout = null;
        let sessionElapsedMs = 0;
        let segmentElapsedMs = 0;
        
        let isPaused = false;
        let wakeLock = null;

        // --- Constants ---
        const HR_SERVICE_UUID = 'heart_rate';
        const HR_CHARACTERISTIC_UUID = 'heart_rate_measurement';
        const BATTERY_SERVICE_UUID = 'battery_service'; // 0x180F
        const BATTERY_LEVEL_UUID = 'battery_level'; // 0x2A19
        
        const MAX_SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 hours
        const INITIAL_CHART_WINDOW_MS = 5 * 60 * 1000; // 5 minutes
        const CHART_Y_MAX_LEVELS = [160, 180, 200]; 

        // --- 3. UI and Helper Functions ---

        function setStatus(status, error = '') {
            statusDisplay.textContent = status;
            errorDisplay.textContent = error;
            console.log(`Status: ${status} ${error ? `(Error: ${error})` : ''}`);

            statusIndicator.className = 'w-3 h-3 rounded-full mr-2'; 
            if (error) {
                statusIndicator.classList.add('bg-red-500'); 
            } else if (status === 'Connected') {
                statusIndicator.classList.add('bg-green-500'); 
            } else if (status === 'Scanning...' || status === 'Connecting...') {
                statusIndicator.classList.add('bg-yellow-500'); 
            } else if (status === 'Paused') {
                statusIndicator.classList.add('bg-blue-500'); 
            } else {
                statusIndicator.classList.add('bg-gray-500'); 
            }
        }

        function updateButtonStates(isRecording, isPaused) {
            startButton.disabled = isRecording;
            stopButton.disabled = !isRecording;
            markButton.disabled = !isRecording || isPaused;
            
            // Logic for Pause Button
            if (isRecording) {
                // Mode: Recording - Show Pause/Resume
                pauseButton.disabled = false;
                // Ensure clean state classes
                pauseButton.classList.remove('bg-blue-600', 'bg-yellow-500', 'active:bg-blue-700', 'active:bg-yellow-600');
                
                if (isPaused) {
                    // Show Play (Resume) icon
                    pauseButton.innerHTML = `<svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.118v3.764a1 1 0 001.555.832l3.197-1.882a1 1 0 000-1.664l-3.197-1.882z" clip-rule="evenodd"></path></svg>`; 
                    pauseButton.setAttribute('aria-label', 'Resume');
                    pauseButton.classList.add('bg-yellow-500', 'active:bg-yellow-600');
                } else {
                    // Show Pause icon
                    pauseButton.innerHTML = `<svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
                    pauseButton.setAttribute('aria-label', 'Pause');
                    pauseButton.classList.add('bg-blue-600', 'active:bg-blue-700');
                }
            } else {
                // Mode: Stopped - Button disabled
                pauseButton.disabled = true;
                pauseButton.innerHTML = `<svg class="btn-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
                pauseButton.className = 'p-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg active:bg-blue-700 disabled:opacity-50 flex justify-center items-center';
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        function updateAverages() {
            // Reverted to simple number array logic
            if (sessionReadings.length > 0) {
                const sessionSum = sessionReadings.reduce((a, b) => a + b, 0);
                sessionAvgBpm.textContent = Math.round(sessionSum / sessionReadings.length);
            } else {
                sessionAvgBpm.textContent = '--';
            }
            
            // segmentReadings is still simple numbers
            if (segmentReadings.length > 0) {
                const segmentSum = segmentReadings.reduce((a, b) => a + b, 0);
                segmentAvgBpm.textContent = Math.round(segmentSum / segmentReadings.length);
            } else {
                segmentAvgBpm.textContent = '--';
            }
        }

        function resetDisplays() {
            stopTimers();
            sessionTimer.textContent = '00:00:00';
            segmentTimer.textContent = '00:00:00';
            bpmDisplay.textContent = '--';
            sessionAvgBpm.textContent = '--';
            segmentAvgBpm.textContent = '--';
            batteryDisplay.classList.add('hidden'); // Hide battery
            sessionElapsedMs = 0;
            segmentElapsedMs = 0;
            isPaused = false;
            setStatus('Idle');
        }

        // --- 4. Timer Functions ---

        function startTimers() {
            sessionStartTime = Date.now() - sessionElapsedMs; 
            segmentStartTime = Date.now() - segmentElapsedMs; 
            
            isPaused = false;
            
            sessionTimerInterval = setInterval(() => {
                sessionElapsedMs = Date.now() - sessionStartTime;
                sessionTimer.textContent = formatTime(sessionElapsedMs);
            }, 1000);
            
            segmentTimerInterval = setInterval(() => {
                segmentElapsedMs = Date.now() - segmentStartTime;
                segmentTimer.textContent = formatTime(segmentElapsedMs);
            }, 1000);
        }

        function stopTimers() {
            clearInterval(sessionTimerInterval);
            clearInterval(segmentTimerInterval);
            sessionTimerInterval = null;
            segmentTimerInterval = null;
        }

        function pauseTimers() {
            stopTimers();
            isPaused = true;
        }

        // --- 5. Charting Functions ---

        function initChart() {
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const ctx = chartCanvas.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: [],
                        borderColor: 'rgb(248, 113, 113)', 
                        backgroundColor: 'rgba(248, 113, 113, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Session Time (Minutes)' },
                            ticks: { color: 'rgb(209, 213, 219)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: true
                        },
                        y: {
                            title: { display: false }, 
                            ticks: { color: 'rgb(209, 213, 219)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 40,
                            max: CHART_Y_MAX_LEVELS[0] 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        annotation: { annotations: {} }
                    }
                }
            });
        }
        
        function updateChartData(timestamp, bpm) {
            if (!chartInstance || isPaused) return; 
            
            const elapsedMinutes = (timestamp - sessionStartTime) / 60000;
            
            chartInstance.data.datasets[0].data.push({ x: elapsedMinutes, y: bpm });
            
            const sessionDurationMs = timestamp - sessionStartTime;
            let maxTime;
            
            if (sessionDurationMs <= INITIAL_CHART_WINDOW_MS) {
                maxTime = INITIAL_CHART_WINDOW_MS / 60000; 
            } else {
                maxTime = elapsedMinutes;
            }
            
            if (chartInstance.options.scales.x.max !== maxTime) {
                chartInstance.options.scales.x.min = 0;
                chartInstance.options.scales.x.max = maxTime;
            }

            const currentYMax = chartInstance.options.scales.y.max;
            if (bpm >= (currentYMax - 5)) { 
                let newMax = currentYMax;
                if (currentYMax < CHART_Y_MAX_LEVELS[1]) newMax = CHART_Y_MAX_LEVELS[1]; 
                else if (currentYMax < CHART_Y_MAX_LEVELS[2]) newMax = CHART_Y_MAX_LEVELS[2]; 
                
                if (newMax !== currentYMax) {
                    chartInstance.options.scales.y.max = newMax;
                }
            }

            chartInstance.update('none'); 
        }

        function addSegmentMarker() {
            if (!chartInstance) return;
            
            const timestamp = Date.now();
            const elapsedMinutes = (timestamp - sessionStartTime) / 60000;
            const annotationName = `segment-${timestamp}`;
            
            chartInstance.options.plugins.annotation.annotations[annotationName] = {
                type: 'line',
                scaleID: 'x',
                value: elapsedMinutes,
                borderColor: 'rgb(234, 179, 8)', 
                borderWidth: 2,
                borderDash: [6, 6],
                label: {
                    content: `Seg ${Object.keys(chartInstance.options.plugins.annotation.annotations).length + 1}`,
                    enabled: true,
                    position: 'start',
                    backgroundColor: 'rgba(234, 179, 8, 0.8)'
                }
            };
            
            chartInstance.update('none');
        }

        // --- 6. Core Logic Functions ---

        async function startRecording() {
            if (bluetoothDevice) {
                await bluetoothDevice.gatt.disconnect();
            }

            sessionReadings = [];
            segmentReadings = [];
            initChart(); 
            resetDisplays();
            
            updateButtonStates(true, false);
            
            if (!await connectToBLE()) {
                stopRecording(); 
                return;
            }
            
            clearTimeout(maxSessionTimeout);
            maxSessionTimeout = setTimeout(() => {
                console.log("Max session duration reached.");
                setStatus("Stopped", "Max session (8h) reached");
                stopRecording();
            }, MAX_SESSION_DURATION);

            await requestWakeLock();
            
            // Protection against accidental tab close
            window.onbeforeunload = function() {
                return "Recording in progress. Are you sure you want to leave?";
            };
        }

        function stopRecording() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.removeEventListener('gattserverdisconnected', onDeviceDisconnect);
                
                if (hrCharacteristic) {
                    // BUG FIX: Removed e.foo
                    hrCharacteristic.stopNotifications()
                        .catch(e => console.warn("Error stopping HR notifications:", e));
                    hrCharacteristic.removeEventListener('characteristicvaluechanged', handleHRData);
                    hrCharacteristic = null;
                }

                if (batteryCharacteristic) {
                    batteryCharacteristic.removeEventListener('characteristicvaluechanged', handleBatteryLevel);
                    batteryCharacteristic = null;
                }
                
                console.log("Disconnecting...");
                bluetoothDevice.gatt.disconnect();
            }
            
            bluetoothDevice = null;
            hrCharacteristic = null;
            batteryCharacteristic = null;
            
            stopTimers();
            clearTimeout(maxSessionTimeout);
            maxSessionTimeout = null;
            
            updateButtonStates(false, false);
            
            if (statusDisplay.textContent !== 'Error') {
                setStatus('Idle');
            }
            
            releaseWakeLock();
            window.onbeforeunload = null; // Remove tab close protection
            console.log("Session stopped.");
        }

        function markSegment() {
            if (isPaused) return; 
            console.log("Marking new segment...");
            addSegmentMarker();
            segmentStartTime = Date.now();
            segmentElapsedMs = 0; 
            segmentTimer.textContent = '00:00:00';
            segmentReadings = [];
            segmentAvgBpm.textContent = '--';
        }

        function togglePause() {
            if (isPaused) {
                startTimers(); 
                updateButtonStates(true, false);
                setStatus('Connected');
            } else {
                pauseTimers(); 
                updateButtonStates(true, true);
                setStatus('Paused');
            }
        }
        
        // Removed exportCSV() function

        // --- 8. Web Bluetooth Functions ---

        async function connectToBLE() {
            if (!navigator.bluetooth) {
                setStatus('Error', 'Web Bluetooth not supported.');
                return false;
            }

            try {
                setStatus('Scanning...');
                
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [HR_SERVICE_UUID] }],
                    optionalServices: [HR_SERVICE_UUID, BATTERY_SERVICE_UUID] // Request Battery too
                });
                
                setStatus('Connecting...');
                bluetoothDevice.addEventListener('gattserverdisconnected', onDeviceDisconnect);
                
                const server = await bluetoothDevice.gatt.connect();
                
                // 1. Heart Rate Service
                const service = await server.getPrimaryService(HR_SERVICE_UUID);
                hrCharacteristic = await service.getCharacteristic(HR_CHARACTERISTIC_UUID);
                await hrCharacteristic.startNotifications();
                hrCharacteristic.addEventListener('characteristicvaluechanged', handleHRData);
                
                // 2. Battery Service (Optional, don't fail if missing)
                try {
                    const batService = await server.getPrimaryService(BATTERY_SERVICE_UUID);
                    batteryCharacteristic = await batService.getCharacteristic(BATTERY_LEVEL_UUID);
                    
                    // Read initial value
                    const val = await batteryCharacteristic.readValue();
                    updateBatteryUI(val.getUint8(0));
                    
                    // Listen for changes (notifications usually not needed for battery but good to have)
                    // await batteryCharacteristic.startNotifications();
                    // batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryLevel);
                } catch (e) {
                    console.log("Battery service not available or permitted:", e);
                }
                
                setStatus('Connected');
                startTimers();
                return true;

            } catch (error) {
                console.error("BT Error:", error);
                if (error.name === 'NotFoundError') {
                    setStatus('Error', 'No device selected.');
                } else if (error.name === 'NotAllowedError') {
                    setStatus('Error', 'Bluetooth permission denied.');
                } else {
                    setStatus('Error', 'Connection failed.');
                }
                return false;
            }
        }
        
        function onDeviceDisconnect() {
            console.log("Device disconnected unexpectedly.");
            setStatus('Error', 'Device Disconnected');
            stopRecording();
        }

        function handleHRData(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const is16bit = flags & 0x01;
            const bpm = is16bit ? value.getUint16(1, true) : value.getUint8(1);
            const timestamp = Date.now();
            
            bpmDisplay.textContent = bpm;
            
            if (isPaused) return; 

            // Reverted: Save just the BPM number
            sessionReadings.push(bpm);
            segmentReadings.push(bpm);
            
            updateAverages();
            updateChartData(timestamp, bpm);
        }
        
        function handleBatteryLevel(event) {
            const level = event.target.value.getUint8(0);
            updateBatteryUI(level);
        }
        
        function updateBatteryUI(level) {
            batteryLevelEl.textContent = level + "%";
            batteryDisplay.classList.remove('hidden');
        }

        // --- 9. Wake Lock Functions ---

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released.');
                    });
                } catch (err) {
                    console.error(`Wake Lock failed:`, err);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // --- 10. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            updateButtonStates(false, false);
            
            if (!navigator.bluetooth) {
                setStatus('Error', 'Use Bluefy (iOS) or Chrome.');
            } else {
                setStatus('Idle');
            }

            startButton.addEventListener('click', startRecording);
            stopButton.addEventListener('click', stopRecording);
            markButton.addEventListener('click', markSegment);
            pauseButton.addEventListener('click', togglePause);

            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await requestWakeLock();
                }
            });
        });
    </script>
</body>
</html>